<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Architecture Eventify - Schémas DB</title>
<link rel="stylesheet" href="style.css">
</head>
<body>

<div class="container">
<h1>Eventify - Documentation des Bases de Données</h1>
<nav>
<a href="#user">User Service</a>
<a href="#event">Event Service</a>
<a href="#reservation">Reservation Service</a>
<a href="#payment">Payment Service</a>
<a href="#resale">Revente Service</a>
<a href="#notif">Notification Service</a>
<a href="#notif">Dashboard Service</a>
</nav>

<h2 id="user">1. User Service (PostgreSQL)</h2>
<div class="mermaid" >
erDiagram
USERS {
UUID id PK
VARCHAR email UK "Unique"
VARCHAR password_hash "Bcrypt"
VARCHAR first_name
VARCHAR last_name
VARCHAR phone
DATE birth_date
TIMESTAMP created_at
VARCHAR role "USER par défaut"
}
ADDRESSES {
UUID id PK
UUID user_id FK
VARCHAR street
VARCHAR city
VARCHAR zip_code
VARCHAR country
}
USERS ||--o{ ADDRESSES : has
</div>

<h2 id="event">2. Event Service (PostgreSQL)</h2>
<div class="mermaid">
erDiagram
    %% --- TABLES EXISTANTES ---
    EVENTS {
        UUID id PK
        UUID venue_id FK "Lien vers la salle"
        UUID category_id FK "Lien vers la catégorie"
        VARCHAR title
        TEXT description
        TIMESTAMP start_date
        TIMESTAMP end_date
        BOOLEAN is_available
    }

    VENUES {
        UUID id PK
        VARCHAR name
        INT capacity
        VARCHAR address
    }

    CATEGORIES {
        UUID id PK
        VARCHAR name
    }

    %% --- NOUVELLES TABLES POUR LE SWAGGER ---
    
    %% Pour gérer le plan de salle (Endpoint /seating-plan)
    %% Hiérarchie : Venue -> Section -> Row -> Seat
    SECTIONS {
        UUID id PK
        UUID venue_id FK
        VARCHAR name "Ex: Fosse, Balcon, Section A"
    }

    ROWS {
        UUID id PK
        UUID section_id FK
        VARCHAR name "Ex: Rangée 1, Rangée B"
    }

    SEATS {
        UUID id PK
        UUID row_id FK
        VARCHAR number "Ex: A12, 45"
        VARCHAR seat_type "Ex: VIP, NORMAL or GOLD"
    }

    %% --- RELATIONS ---
    EVENTS }|--|| VENUES : takes_place_in
    EVENTS }|--|| CATEGORIES : has_type
  
    
    VENUES ||--|{ SECTIONS : contains
    SECTIONS ||--|{ ROWS : contains
    ROWS ||--|{ SEATS : contains
</div>
<h2 id="reservation">3. Reservation Service (PostgreSQL)</h2>
<div class="mermaid">
erDiagram
RESERVATIONS {
UUID id PK
UUID user_id "Référence logique vers User Service"
UUID event_id "Référence logique vers Event Service"
TIMESTAMP created_at
VARCHAR status "PENDING, CONFIRMED, CANCELLED"
DECIMAL total_amount
}
RESERVED_SEATS {
UUID id PK
UUID reservation_id FK
VARCHAR seat_type "Ex: VIP, NORMAL or GOLD"
VARCHAR seat_number "Ex: A12 ou NULL si placement libre"
}

RESERVATIONS ||--|{ RESERVED_SEATS : contains
</div>

<h2 id="payment">4. Payment Service (PostgreSQL)</h2>
<div class="mermaid">
erDiagram
TRANSACTIONS {
UUID id PK
UUID reservation_id "Lien vers Reservation"
UUID user_id
DECIMAL amount
VARCHAR currency
VARCHAR status "INITIATED, SUCCESS, FAILED, REFUNDED"
VARCHAR payment_method "STRIPE, PAYPAL"
TIMESTAMP transaction_date
VARCHAR provider_transaction_id "ID externe (Stripe)"
}
INVOICES {
UUID id PK
UUID transaction_id FK
VARCHAR invoice_number UK
VARCHAR pdf_url
TIMESTAMP generated_at
}

TRANSACTIONS ||--|| INVOICES : generates
</div>

<h2 id="resale">5. Revente Service (PostgreSQL)</h2>
<div class="mermaid">
erDiagram
RESALE_OFFERS {
UUID id PK
UUID original_reservation_id
UUID seller_user_id
DECIMAL price
VARCHAR status "OPEN, SOLD, CANCELLED"
TIMESTAMP created_at
}
RESALE_TRANSACTIONS {
UUID id PK
UUID resale_offer_id FK
UUID buyer_user_id
TIMESTAMP sold_at
}
RESALE_OFFERS ||--o| RESALE_TRANSACTIONS : completes
</div>
<h2 id="notif">6. Notification Service (NoSQL - MongoDB)</h2>
<div class="mermaid">
erDiagram
    NOTIFICATIONS {
        ObjectId _id PK
        String type "EMAIL, PUSH, SMS"
        UUID user_id
        String message
        String status "SENT, FAILED"
        Timestamp created_at
    }

    EVENT_INTERESTS {
        ObjectId _id PK
        UUID user_id
        UUID event_id
        Boolean notified
        Timestamp created_at
    }

    EVENT_UPDATES {
        ObjectId _id PK
        UUID event_id
        String update_type "MODIFICATION, CANCELLATION"
        String description
        Timestamp created_at
    }

    PROMOTIONAL_CAMPAIGNS {
        ObjectId _id PK
        UUID event_id
        String message
        Array target_users
        Timestamp sent_at
    }

    EVENT_INTERESTS ||--o{ NOTIFICATIONS : triggers
    EVENT_UPDATES ||--o{ NOTIFICATIONS : generates
    PROMOTIONAL_CAMPAIGNS ||--o{ NOTIFICATIONS : creates
</div>

<h2 id="dashboard">7. Dashboard Service (Analytique - ClickHouse/Elastic)</h2>
<p><strong>Pas de schéma de base de données dédié.</strong></p>
<p>
Le Dashboard Service est un service d'<strong>agrégation et de lecture</strong> qui interroge les autres microservices 
(User, Event, Reservation, Payment) pour calculer et afficher des statistiques en temps réel. 
ClickHouse/Elastic sont utilisés comme <strong>cache analytique</strong> pour améliorer les performances 
des requêtes complexes, mais ne stockent pas de nouvelles entités métier.
</p>

</div>

<script type="module">
import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
mermaid.initialize({ startOnLoad: true, theme: 'default' });
</script>

</body>
</html>